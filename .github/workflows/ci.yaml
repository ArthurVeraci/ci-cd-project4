name: CI - Tests & Integration

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install deps
        run: pip install -r requirements.txt
      - name: Run flake8
        run: flake8 .

  unit-tests:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install deps
        run: pip install -r requirements.txt
      - name: Run unit tests
        run: pytest tests/unit --junitxml=reports/unit-junit.xml --cov=. --cov-report=xml
      - name: Upload unit junit
        uses: actions/upload-artifact@v4
        with:
          name: unit-junit
          path: reports/unit-junit.xml
      - name: Upload coverage xml
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v3
      
      - name: Build docker image for integration
        run: |
          docker build -t flask-ci-integration:latest .
      
      - name: Run container
        run: |
          docker run -d --name test-app -p 5000:5000 flask-ci-integration:latest
          echo "Container started, waiting 5 seconds..."
          sleep 5
          
      - name: Debug - Check container
        run: |
          echo "=== Container Status ==="
          docker ps -a
          echo ""
          echo "=== Container Logs ==="
          docker logs test-app
          echo ""
          echo "=== Test curl ==="
          curl -v http://localhost:5000/ || true
          
      - name: Wait for app
        run: |
          for i in $(seq 1 30); do
            if curl -f -sS http://localhost:5000/ >/dev/null 2>&1; then
              echo "✅ App is up!"
              exit 0
            fi
            echo "⏳ Attempt $i/30..."
            sleep 2
          done
          echo "❌ Failed to start"
          docker logs test-app
          exit 1
      
      - name: Run integration tests
        run: |
          pip install -r requirements.txt
          pytest tests/integration --junitxml=reports/integration-junit.xml -q
      
      - name: Stop container
        if: always()
        run: |
          docker stop test-app || true
          docker rm test-app || true
      
      - name: Upload integration junit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-junit
          path: reports/integration-junit.xml