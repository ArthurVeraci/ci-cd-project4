name: CI - Tests & Integration

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install deps
        run: pip install -r requirements.txt
      - name: Run flake8
        run: flake8 .

  unit-tests:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install deps
        run: pip install -r requirements.txt
      - name: Run unit tests
        run: pytest tests/unit --junitxml=reports/unit-junit.xml --cov=. --cov-report=xml
      - name: Upload unit junit
        uses: actions/upload-artifact@v4
        with:
          name: unit-junit
          path: reports/unit-junit.xml
      - name: Upload coverage xml
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v3
      - name: Build docker image for integration
        run: |
          docker build -t flask-ci-integration:latest .
      - - name: Run container
          run: |
          docker run -d --name test-app -p 5000:5000 flask-ci-integration:latest
          sleep 3  # dÃ¡ tempo pro Gunicorn iniciar
      - n- name: Wait for app
        run: |
          echo "ğŸ” Checking container status..."
          docker ps -a
          echo ""
          echo "ğŸ“‹ Container logs:"
          docker logs test-app
          echo ""
          echo "â³ Waiting for app to be ready..."
          for i in $(seq 1 30); do
            if curl -f -sS http://localhost:5000/ >/dev/null 2>&1; then
              echo "âœ… App is up and responding!"
              exit 0
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 2
          done
          echo "âŒ App failed to start after 60 seconds"
          echo "ğŸ“‹ Final container logs:"
          docker logs test-app
          exit 1
      - name: Run integration tests
        run: |
          pip install -r requirements.txt
          pytest tests/integration --junitxml=reports/integration-junit.xml -q
      - name: Stop container
        if: always()
        run: |
          docker stop test-app
          docker rm test-app
      - name: Upload integration junit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-junit
          path: reports/integration-junit.xml
